<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Farm AI Chat â€” Singleâ€‘file React + OpenAI</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root{
        --bg:#0b1220; --bg2:#0e1630; --panel:#101a2d; --ink:#e6edf3; --muted:#9db0c9;
        --accent:#58c88e; --ai:#233352; --user:#1f2b46; --border:#1b2740;
      }
      html,body{height:100%;margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;background:radial-gradient(1200px 800px at 10% 10%,#0b1732 0%,#0b1220 60%), linear-gradient(120deg,var(--bg),var(--bg2) 60%, #14234f);color:var(--ink)}
      .wrap{max-width:920px;margin:40px auto;padding:0 20px}
      .card{background:var(--panel);border:1px solid var(--border);border-radius:18px;box-shadow:0 16px 50px rgba(0,0,0,.35);overflow:hidden;display:grid;grid-template-rows:auto 1fr auto;min-height:70vh}
      .head{padding:16px 18px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px}
      .dot{width:10px;height:10px;border-radius:50%;background:var(--accent);box-shadow:0 0 10px var(--accent)}
      .title{font-weight:800;letter-spacing:.2px}
      .sub{color:var(--muted);font-size:12px;margin-left:auto}
      .chat{padding:16px;height:100%;overflow:auto;background:
        linear-gradient(rgba(0,0,0,.12), rgba(0,0,0,.12)), 
        url('https://images.unsplash.com/photo-1500382017468-9049fed747ef?q=80&w=2070&auto=format&fit=crop') center/cover no-repeat fixed}
      .msgs{list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:10px}
      .msg{display:flex;gap:10px;align-items:flex-end}
      .msg.ai{justify-content:flex-start}
      .msg.user{justify-content:flex-end}
      .bubble{max-width:72ch;padding:12px 14px;border-radius:14px;border:1px solid var(--border);box-shadow:0 10px 24px rgba(0,0,0,.25)}
      .ai .bubble{background:rgba(20,33,66,.7);backdrop-filter: blur(4px)}
      .user .bubble{background:linear-gradient(180deg,#1f3a2e,#142d23); border-color:#244937}
      .role{font-size:11px;color:var(--muted);margin:0 6px}
      .content{white-space:pre-wrap}
      .inputBar{padding:12px;border-top:1px solid var(--border);background:linear-gradient(180deg,rgba(17,26,43,.9),rgba(17,26,43,.95));display:flex;gap:10px;align-items:flex-end}
      .textbox{flex:1;display:grid;gap:6px}
      textarea{width:100%;min-height:52px;max-height:200px;resize:vertical;border-radius:12px;border:1px solid #20345b;background:#0b1730;color:var(--ink);padding:12px 14px;outline:none}
      textarea::placeholder{color:#6f86a7}
      .actions{display:flex;gap:8px;align-items:center}
      .btn{background:var(--accent);border:none;color:#062114;font-weight:800;padding:10px 14px;border-radius:10px;cursor:pointer}
      .ghost{background:#17233c;color:#cdd8e8;border:1px solid #243458}
      .btn[disabled]{opacity:.6;cursor:not-allowed}
      .footnote{display:flex;justify-content:space-between;align-items:center;color:var(--muted);font-size:12px;padding:6px 2px}
      a{color:var(--accent);text-decoration:none}
      .error{color:#ff8c8c}
      .k{background:#0e1a31;border:1px dashed #27416f;padding:6px 8px;border-radius:8px;color:#b6c7dc;font-size:12px}
      .typing{color:#b6c7dc;font-size:12px}
      code{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    </style>
    <!-- React 18 (UMD) + Babel so JSX works in one file -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  </head>
  <body>
    <div class="wrap">
      <div id="root"></div>
    </div>

    <script type="text/babel">
      const {useEffect, useRef, useState} = React;

      // âš ï¸ For quick local demos ONLY. Never ship an exposed API key.
      const OPENAI_API_KEY = "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";

      const SYS_PROMPT = "You are Farm AI Chat, a crisp, helpful assistant. Keep answers concise unless asked to go deep. Use markdown for lists/code.";

      function App(){
        const [messages, setMessages] = useState(() => {
          const saved = localStorage.getItem("farm-chat");
          return saved ? JSON.parse(saved) : [
            {role:"assistant", content:"ðŸ‘‹ Hi! Iâ€™m **Farm AI Chat**. Ask me anythingâ€”press Enter to send, Shift+Enter for a new line."}
          ];
        });
        const [input, setInput] = useState("");
        const [busy, setBusy] = useState(false);
        const [error, setError] = useState("");
        const [typing, setTyping] = useState(false);
        const chatRef = useRef(null);
        const controllerRef = useRef(null);

        useEffect(() => {
          localStorage.setItem("farm-chat", JSON.stringify(messages));
          // Autoscroll
          if (chatRef.current){
            chatRef.current.scrollTop = chatRef.current.scrollHeight;
          }
        }, [messages]);

        function clearChat(){
          setMessages([{role:"assistant", content:"Chat cleared. How can I help?"}]);
          setError("");
        }

        async function sendMessage(){
          const text = input.trim();
          if (!text || busy) return;
          setInput("");
          setError("");
          const newMsgs = [...messages, {role:"user", content:text}];
          setMessages(newMsgs);
          setBusy(true);
          setTyping(true);

          const controller = new AbortController();
          controllerRef.current = controller;

          try {
            // Stream from Chat Completions
            const res = await fetch("https://api.openai.com/v1/chat/completions", {
              method: "POST",
              headers: {
                "Content-Type":"application/json",
                "Authorization": `Bearer ${OPENAI_API_KEY}`
              },
              body: JSON.stringify({
                model: "gpt-4o-mini",
                stream: true,
                messages: [
                  {role:"system", content: SYS_PROMPT},
                  ...newMsgs.map(m => ({role:m.role, content:m.content}))
                ]
              }),
              signal: controller.signal
            });

            if (!res.ok){
              const t = await res.text().catch(() => "");
              throw new Error(`HTTP ${res.status}: ${t || res.statusText}`);
            }

            const reader = res.body.getReader();
            const decoder = new TextDecoder("utf-8");
            let assistantText = "";
            let started = false;
            let buf = "";

            while (true){
              const {value, done} = await reader.read();
              if (done) break;
              buf += decoder.decode(value, {stream:true});

              // process complete SSE events separated by blank lines
              let idx;
              while ((idx = buf.indexOf("\n\n")) !== -1){
                const event = buf.slice(0, idx);
                buf = buf.slice(idx + 2);

                // Accumulate all "data:" lines in the event block
                const dataLines = event.split("\n").filter(l => l.startsWith("data:"));
                if (dataLines.length === 0) continue;
                const payload = dataLines.map(l => l.replace(/^data:\s*/, "")).join("");

                if (payload === "[DONE]") continue;

                try{
                  const json = JSON.parse(payload);
                  const delta = json.choices?.[0]?.delta?.content ?? "";
                  if (delta){
                    if (!started){
                      setMessages(curr => [...curr, {role:"assistant", content:""}]);
                      started = true;
                    }
                    assistantText += delta;
                    setMessages(curr => {
                      const copy = curr.slice();
                      copy[copy.length - 1] = {role:"assistant", content:assistantText};
                      return copy;
                    });
                  }
                }catch(_e){
                  // ignore parse issues for partial/incomplete frames
                }
              }
            }

            if (!started){
              setError("No content streamed. Check your network/key or try again.");
            }
        } catch (e){
            if (e.name === "AbortError"){
              setError("Generation stopped.");
            } else {
              setError(e.message || String(e));
            }
          } finally {
            setBusy(false);
            setTyping(false);
            controllerRef.current = null;
          }
        }

        function stop(){
          controllerRef.current?.abort();
        }

        function onKeyDown(e){
          if (e.key === "Enter" && !e.shiftKey){
            e.preventDefault();
            sendMessage();
          }
        }

        return (
          <div className="card">
            <div className="head">
              <span className="dot"></span>
              <div className="title">Farm AI Chat</div>
              <div className="sub">gpt-4o-mini Â· streaming</div>
            </div>

            <div className="chat" ref={chatRef}>
              <ul className="msgs">
                {messages.map((m,i) => (
                  <li key={i} className={"msg " + (m.role === "user" ? "user" : "ai")}>
                    {m.role !== "user" && <span className="role">AI</span>}
                    <div className="bubble">
                      <div className="content" dangerouslySetInnerHTML={{__html: renderMarkdown(m.content)}}></div>
                    </div>
                    {m.role === "user" && <span className="role">You</span>}
                  </li>
                ))}
                {typing && <li className="msg ai"><span className="typing">AI is typingâ€¦</span></li>}
              </ul>
            </div>

            <div className="inputBar">
              <div className="textbox" style={{flex:1}}>
                <textarea
                  value={input}
                  onChange={e => setInput(e.target.value)}
                  onKeyDown={onKeyDown}
                  placeholder="Ask somethingâ€¦ (Enter to send, Shift+Enter for newline)"
                  spellCheck="false"
                />
                <div className="footnote">
                  <span>
                    <span className="k">Tip</span> Never expose real keys in productionâ€”proxy this request via your backend.
                  </span>
                  {error && <span className="error">{error}</span>}
                </div>
              </div>
              <div className="actions">
                {!busy ? (
                  <button className="btn" onClick={sendMessage} disabled={!input.trim()}>Send</button>
                ) : (
                  <button className="btn ghost" onClick={stop}>Stop</button>
                )}
                <button className="btn ghost" onClick={clearChat}>Clear</button>
              </div>
            </div>
          </div>
        );
      }

      // Minimal markdown renderer (bold, italics, code, links, line breaks).
      function renderMarkdown(s=""){
        // Escape first
        const esc = str => str.replace(/[&<>]/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[ch]));
        let html = esc(s);

        // Inline code
        html = html.replace(/`([^`]+?)`/g, "<code>$1</code>");

        // Bold **text** (no whitespace-only)
        html = html.replace(/\*\*(?=\S)([\s\S]*?\S)\*\*/g, "<strong>$1</strong>");

        // Italic *text* but not **bold**
        html = html.replace(/(^|[^*])\*(?=\S)([^*]*?\S)\*(?!\*)/g, "$1<em>$2</em>");

        // Links [text](http...)
        html = html.replace(/\[([^\]]+)\]\((https?:[^\s)]+)\)/g, '<a href="$2" target="_blank" rel="noreferrer">$1</a>');

        // Newlines
        html = html.replace(/\n/g, "<br/>");
        return html;
      }

      ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
    </script>
  
<!-- Chat history persistence toggle (top-right) -->
<style>
  #persist-control{position:fixed;top:12px;right:12px;z-index:9999;
    background:rgba(255,255,255,0.9);backdrop-filter:saturate(150%) blur(4px);
    border:1px solid rgba(0,0,0,0.06);box-shadow:0 6px 18px rgba(0,0,0,0.12);
    padding:10px 12px;border-radius:14px;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
    display:flex;align-items:center;gap:8px}
  #persist-control input[type="checkbox"]{width:18px;height:18px;cursor:pointer}
  #persist-control label{font-size:13px;line-height:1.2;cursor:pointer;color:#0b3d1a}
</style>
<div id="persist-control">
  <input type="checkbox" id="persistToggle" />
  <label for="persistToggle" title="Keep chat history between page reloads">Remember chat between refreshes</label>
</div>

<script>
(function(){
  const CHAT_KEY = "farm-chat";
  const PERSIST_KEY = "farm-chat-persist";

  // default to false (no persistence) unless previously set
  if(localStorage.getItem(PERSIST_KEY) === null){
    localStorage.setItem(PERSIST_KEY, "false");
  }

  const isPersistOn = () => localStorage.getItem(PERSIST_KEY) === "true";

  // If persistence is OFF, wipe existing chat on each load and block future saves
  if(!isPersistOn()){
    try{ localStorage.removeItem(CHAT_KEY); }catch(e){ /* ignore */ }
    // Monkey-patch setItem to ignore writes to CHAT_KEY during this session
    const _setItem = localStorage.setItem.bind(localStorage);
    localStorage.setItem = function(k,v){
      if(k === CHAT_KEY) return; // ignore writes to chat history
      return _setItem(k,v);
    };
  }

  // Wire up the toggle UI
  window.addEventListener("DOMContentLoaded", function(){
    const el = document.getElementById("persistToggle");
    if(!el) return;
    el.checked = isPersistOn();
    el.addEventListener("change", function(e){
      localStorage.setItem(PERSIST_KEY, e.target.checked ? "true" : "false");
      // Give immediate feedback and enforce the new choice by reloading
      const msg = e.target.checked ? "Persistence enabled. Your chat will be kept after refresh." 
                                   : "Persistence disabled. Chat will reset on next refresh.";
      console.log(msg);
      // Optional: tiny delay so users see UI change before reload
      setTimeout(()=> location.reload(), 150);
    });
  });
})();
</script>
</body>
</html>

